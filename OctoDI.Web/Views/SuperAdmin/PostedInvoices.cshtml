@model IEnumerable<OctoDI.Web.Models.DatabaseModels.Invoice>
@{
    ViewData["Title"] = "Posted Invoices";
    var pageNumber = ViewBag.PageNumber ?? 1;
    var totalPages = ViewBag.TotalPages ?? 1;
    var pageSize = ViewBag.PageSize ?? 10;
    var totalRecords = ViewBag.TotalRecords ?? 0;
}
<style>
    .btn-purple {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white !important;
        border: none;
        padding: 8px 18px;
        font-weight: 600;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

        .btn-purple:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(102, 126, 234, 0.6);
        }

</style>
<div class="container-fluid mt-4">
    <!-- Header -->
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark mb-0">
            <i class="bi bi-receipt-cutoff"></i> Posted Invoices
        </h2>
        @* <a asp-controller="SuperAdmin" asp-action="Dashboard" asp-route-subscriptionId="@ViewBag.SubscriptionId" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Users
        </a> *@

    </div>
    <!-- Filters Card -->
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <form method="get" asp-controller="SuperAdmin" asp-action="PostedInvoices" class="row g-3" id="filterForm">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Company</label>
                    <select name="subscriptionId" class="form-select">
                        <option value="">All Companies</option>
                        @foreach (var sub in ViewBag.AllSubscriptions)
                        {
                            <option value="@sub.SubscriptionId"
                                    selected="@(ViewBag.SubscriptionId == sub.SubscriptionId)">
                                @sub.CompanyName
                            </option>
                        }
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="form-label fw-bold">Search</label>
                    <input type="text" name="search" class="form-control" 
                           placeholder="Invoice Ref No, FBR No, or Buyer Name"
                           value="@ViewBag.SearchTerm" />
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn-purple me-2">
                        <i class="bi bi-search"></i> Search
                    </button>

                    <a asp-controller="SuperAdmin" asp-action="PostedInvoices" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Count -->
    <div class="mb-3">
        <small class="text-muted">
            Showing @((pageNumber - 1) * pageSize + 1) to @Math.Min(pageNumber * pageSize, totalRecords) of @totalRecords posted invoices
        </small>
    </div>

    <!-- Invoices Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Invoice Ref No</th>
                                <th>FBR Invoice No</th>
                                <th>Company Name</th>
                                <th>Address</th>
                                <th>Buyer</th>
                                <th>Invoice Date</th>
                                <th>Type</th>
                                <th>Items</th>
                                <th>Total Amount</th>
                                <th>Status</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var invoice in Model)
                            {
                                var totalAmount = invoice.Items?.Sum(i => i.ValueExclST ?? 0) ?? 0;

                                <tr id="invoice-row-@invoice.InvoiceId">
                                    <td>
                                        <small class="text-dark fw-bold">@invoice.InvoiceRefNo</small>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(invoice.FBRInvoiceNo))
                                        {
                                            <span class="badge bg-info">@invoice.FBRInvoiceNo</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <small class="text-dark">
                                            <i class="bi bi-building"></i> @invoice.Subscription?.CompanyName
                                        </small>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            @invoice.Subscription?.Address
                                        </small>
                                    </td>
                                    <td>
                                        <div>
                                            <small>@invoice.Buyer?.BuyerBusinessName</small>
                                            @if (!string.IsNullOrEmpty(invoice.Buyer?.BuyerNTN))
                                            {
                                                <br />
                                                <small class="text-muted">NTN: @invoice.Buyer.BuyerNTN</small>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <small>@invoice.InvoiceDate.ToString("MMM dd, yyyy")</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">@invoice.InvoiceType</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">
                                            @(invoice.Items?.Count ?? 0) items
                                        </span>
                                    </td>
                                    <td>
                                        <strong class="text-success">Rs. @totalAmount.ToString("N2")</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">Posted</span>
                                    </td>
                                    <td class="text-center">
                                        <a asp-controller="SuperAdmin"
                                           asp-action="PostedInvoiceDetails"
                                           asp-route-id="@invoice.InvoiceId"
                                           class="btn btn-outline-info btn-sm"
                                           title="View Details">
                                            <i class="bi bi-eye"></i> Details
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                @if (totalPages > 1)
                {
                    <nav aria-label="Invoice pagination">
                        <ul class="pagination justify-content-center mt-4">
                            <li class="page-item @(pageNumber == 1 ? "disabled" : "")">
                                <a class="page-link"
                                   href="?subscriptionId=@ViewBag.SubscriptionId&search=@ViewBag.SearchTerm&page=@(pageNumber - 1)&pageSize=@pageSize">
                                    <i class="bi bi-chevron-left"></i> Previous
                                </a>
                            </li>

                            @{
                                int maxPagesToShow = 5;
                                int startPage = Math.Max(1, pageNumber - (maxPagesToShow / 2));
                                int endPage = Math.Min(totalPages, startPage + maxPagesToShow - 1);

                                if ((endPage - startPage) < (maxPagesToShow - 1))
                                {
                                    startPage = Math.Max(1, endPage - maxPagesToShow + 1);
                                }
                            }

                            @for (int i = startPage; i <= endPage; i++)
                            {
                                <li class="page-item @(i == pageNumber ? "active" : "")">
                                    <a class="page-link"
                                       href="?subscriptionId=@ViewBag.SubscriptionId&search=@ViewBag.SearchTerm&page=@i&pageSize=@pageSize">
                                        @i
                                    </a>
                                </li>
                            }

                            <li class="page-item @(pageNumber == totalPages ? "disabled" : "")">
                                <a class="page-link"
                                   href="?subscriptionId=@ViewBag.SubscriptionId&search=@ViewBag.SearchTerm&page=@(pageNumber + 1)&pageSize=@pageSize">
                                    Next <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h4 class="mt-3 text-muted">No Posted Invoices Found</h4>
                    <p class="text-muted">
                        @if (!string.IsNullOrEmpty(ViewBag.SearchTerm) || ViewBag.SubscriptionId > 0)
                        {
                            <span>Try adjusting your filters.</span>
                        }
                        else
                        {
                            <span>No invoices have been posted to FBR yet.</span>
                        }
                    </p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ==================== TEMPDATA ALERTS ====================
        @if (TempData["Success"] != null)
        {
                <text>
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: '@TempData["Success"]',
                        timer: 2500,
                        showConfirmButton: false
                    });
                </text>
        }

        @if (TempData["Error"] != null)
        {
                <text>
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: '@TempData["Error"]'
                    });
                </text>
        }
    </script>
}