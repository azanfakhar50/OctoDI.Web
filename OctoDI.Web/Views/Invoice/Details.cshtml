@model OctoDI.Web.Models.DatabaseModels.Invoice
@{
    ViewData["Title"] = "Invoice Details";
    var subtotal = Model.Items?.Sum(i => i.ValueExclST ?? 0) ?? 0;
    var totalTax = Model.Items?.Sum(i => i.SalesTaxApplicable ?? 0) ?? 0;
    var totalDiscount = Model.Items?.Sum(i => i.Discount ?? 0) ?? 0;
    var grandTotal = subtotal + totalTax - totalDiscount;

    // Get subscription details from ViewBag
    var subscription = ViewBag.Subscription as OctoDI.Web.Models.DatabaseModels.Subscription;

    // Check if SuperAdmin
    var isSuperAdmin = User.IsInRole("SuperAdmin");
    var backController = isSuperAdmin ? "SuperAdmin" : "Invoice";
}

<div class="container-fluid mt-4">
    <!-- Action Buttons -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary mb-0">
            <i class="bi bi-receipt"></i> Invoice Details
        </h2>
        <div class="btn-group">
            <a asp-controller="@backController" asp-action="Index" asp-route-subscriptionId="@Model.SubscriptionId" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
            @if (!isSuperAdmin)
            {
                <a asp-controller="Invoice" asp-action="Edit" asp-route-id="@Model.InvoiceId" class="btn btn-outline-primary">
                    <i class="bi bi-pencil"></i> Edit
                </a>
            }
            <button onclick="window.print()" class="btn btn-outline-info">
                <i class="bi bi-printer"></i> Print
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <!-- Invoice Card -->
            <div class="card shadow-sm" id="printableInvoice">
                <div class="card-body p-4">
                    <!-- Invoice Header -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h3 class="text-primary fw-bold">INVOICE</h3>
                            <p class="mb-1"><strong>Invoice Ref:</strong> @Model.InvoiceRefNo</p>
                            @if (!string.IsNullOrEmpty(Model.FBRInvoiceNo))
                            {
                                <p class="mb-1"><strong>FBR Invoice No:</strong> @Model.FBRInvoiceNo</p>
                            }
                            <p class="mb-1"><strong>Date:</strong> @Model.InvoiceDate.ToString("MMMM dd, yyyy")</p>
                            <p class="mb-1"><strong>Type:</strong> <span class="badge bg-secondary">@Model.InvoiceType</span></p>
                        </div>
                        <div class="col-md-6 text-end">
                            @if (subscription != null)
                            {
                                <h4 class="text-uppercase fw-bold">@(subscription.CompanyName ?? subscription.CompanyName)</h4>
                                @if (!string.IsNullOrEmpty(subscription.Address))
                                {
                                    <p class="mb-1">@subscription.Address</p>
                                }
                                @if (!string.IsNullOrEmpty(subscription.Province))
                                {
                                    <p class="mb-1">@subscription.Province</p>
                                }
                                @if (!string.IsNullOrEmpty(subscription.NtnCnic))
                                {
                                    <p class="mb-1"><strong>NTN:</strong> @subscription.NtnCnic</p>
                                }
                                @if (!string.IsNullOrEmpty(subscription.ContactPhone))
                                {
                                    <p class="mb-1"><strong>Phone:</strong> @subscription.ContactPhone</p>
                                }
                                @if (!string.IsNullOrEmpty(subscription.ContactEmail))
                                {
                                    <p class="mb-1"><strong>Email:</strong> @subscription.ContactEmail</p>
                                }
                            }
                            else
                            {
                                <h4 class="text-uppercase fw-bold">YOUR COMPANY NAME</h4>
                                <p class="mb-1">Your Company Address</p>
                                <p class="mb-1">City, Province, ZIP</p>
                                <p class="mb-1">NTN: XXXXXXXXX</p>
                                <p class="mb-1">Phone: +XX-XXX-XXXXXXX</p>
                            }
                        </div>
                    </div>

                    <hr>

                    <!-- Buyer Information -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5 class="fw-bold mb-3">Bill To:</h5>
                            <p class="mb-1"><strong>@Model.Buyer?.BuyerBusinessName</strong></p>
                            <p class="mb-1">@Model.Buyer?.BuyerAddress</p>
                            <p class="mb-1">@Model.Buyer?.BuyerProvince</p>
                            @if (!string.IsNullOrEmpty(Model.Buyer?.BuyerNTN))
                            {
                                <p class="mb-1"><strong>NTN:</strong> @Model.Buyer.BuyerNTN</p>
                            }
                            @if (!string.IsNullOrEmpty(Model.Buyer?.BuyerRegistrationType))
                            {
                                <p class="mb-1"><strong>Registration:</strong> @Model.Buyer.BuyerRegistrationType</p>
                            }
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="alert alert-@(Model.Status == "Paid" ? "success" : Model.Status == "Cancelled" ? "danger" : "warning") d-inline-block">
                                <h4 class="mb-0">Status: @Model.Status</h4>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Items Table -->
                    <div class="table-responsive mb-4">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>HS Code</th>
                                    <th>Product Description</th>
                                    @* <th class="text-center">UOM</th> *@
                                    <th class="text-end">Rate</th>
                                    <th class="text-end">Qty</th>
                                    @* <th class="text-end">Value (Excl ST)</th>
                                    <th class="text-end">Sales Tax</th>
                                    <th class="text-end">Discount</th>
                                    <th class="text-end">Total</th> *@
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Items != null && Model.Items.Any())
                                {
                                    int index = 1;
                                    foreach (var item in Model.Items)
                                    {
                                        var itemTotal = (item.ValueExclST ?? 0) + (item.SalesTaxApplicable ?? 0) - (item.Discount ?? 0);
                                        <tr>
                                            <td>@index</td>
                                            <td>@item.HSCode</td>
                                            <td>@item.ProductDescription</td>
                                            @* <td class="text-center">@item.UOM</td> *@
                                            <td class="text-end">@item.Rate?.ToString("N2")</td>
                                            <td class="text-end">@item.Quantity?.ToString("N2")</td>
                                           @*  <td class="text-end">@item.ValueExclST?.ToString("N2")</td>
                                            <td class="text-end">@item.SalesTaxApplicable?.ToString("N2")</td>
                                            <td class="text-end text-danger">@item.Discount?.ToString("N2")</td> *@
                                            @* <td class="text-end"><strong>@itemTotal.ToString("N2")</strong></td> *@
                                        </tr>
                                        index++;
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="10" class="text-center text-muted">No items found</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary Section -->
                    <div class="row">
                        <div class="col-md-6">
                            @if (!string.IsNullOrEmpty(Model.Remarks))
                            {
                                <div class="alert alert-info">
                                    <strong><i class="bi bi-info-circle"></i> Remarks:</strong>
                                    <p class="mb-0 mt-2">@Model.Remarks</p>
                                </div>
                            }
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="text-end"><strong>Subtotal:</strong></td>
                                    <td class="text-end" style="width: 150px;">Rs. @subtotal.ToString("N2")</td>
                                </tr>
                                <tr>
                                    <td class="text-end"><strong>Sales Tax:</strong></td>
                                    <td class="text-end">Rs. @totalTax.ToString("N2")</td>
                                </tr>
                                <tr>
                                    <td class="text-end"><strong>Discount:</strong></td>
                                    <td class="text-end text-danger">- Rs. @totalDiscount.ToString("N2")</td>
                                </tr>
                                <tr class="border-top">
                                    <td class="text-end"><h4 class="mb-0">Grand Total:</h4></td>
                                    <td class="text-end"><h4 class="mb-0 text-success">Rs. @grandTotal.ToString("N2")</h4></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <hr>

                    <!-- Footer -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <p class="text-muted small mb-1">
                                <strong>Created By:</strong> @Model.CreatedBy on @Model.CreatedDate.ToString("MMM dd, yyyy hh:mm tt")
                            </p>
                            @if (Model.UpdatedDate.HasValue)
                            {
                                <p class="text-muted small">
                                    <strong>Last Updated:</strong> @Model.UpdatedBy on @Model.UpdatedDate?.ToString("MMM dd, yyyy hh:mm tt")
                                </p>
                            }
                        </div>
                        <div class="col-md-6 text-end">
                            <p class="mb-0"><strong>Terms & Conditions:</strong></p>
                            <p class="small text-muted">Payment due within 30 days of invoice date.</p>
                        </div>
                    </div>
                </div>
            </div>

          
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function updateStatus(invoiceId, status) {
            if (confirm(`Are you sure you want to change invoice status to "${status}"?`)) {
                fetch('@Url.Action("UpdateStatus", "Invoice")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': '@Html.AntiForgeryToken()'
                    },
                    body: JSON.stringify({ id: invoiceId, status: status })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Error updating status: ' + error);
                });
            }
        }
    </script>
}

<style>
    @@media print {
        .d-print-none {
            display: none !important;
        }

        .card {
            border: none !important;
            box-shadow: none !important;
        }
    }
</style>